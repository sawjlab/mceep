#!/bin/sh
#
# ----------------------------------------------------------------
#
# This script generates an include file from the file "skeleton",
# produced by mceep_util (option 5).  It then copies this include
# file to the directory pointed to by $mceep_cmn and recompiles
# and links mceep_util.
#
# This script should be run from the directory where the input
# ESPACE HBOOK file is located!
#
# ----------------------------------------------------------------
#
current_dir=`pwd`
#
echo 'C ' > ntu.cmn
echo 'C This file is generated by the script build_cwn_include. ' >> ntu.cmn
echo 'C For a saved example, see ~/mceep/cmn/ntu_sav.cmn ' >> ntu.cmn
echo 'C ' >> ntu.cmn
awk 'BEGIN {FS=","} /REAL/,/*/ {print}' skeleton >> ntu.cmn
awk 'BEGIN {FS=","} /BLOCK1/,/*/' ntu.cmn | \
awk 'BEGIN {FS=","} 
    {
    n=1
    while (n<=NF) {
       if(n==1 && NR==1)
             {print "      REAL FIRST_VAR"
              print "      EQUIVALENCE ("substr($n,23,length($n))",FIRST_VAR)\n*"
              print $n":R*4:"
              ++n}
       if(n>1 || NR>1)
               {m=0
                line="     +   "
                while (m<=3 && m+n<=NF) {
                   if($(m+n)!="     + " && $(m+n)!="*" \
                      && $(m+n)!="Event" && $(m+n)!="Index" \
                      && $(m+n)!="Subdet")
                     {line=line","$(m+n)":R*4:"}
                   ++m} 
                if(line!="     +   ") {print line}
                n +=4 }
             }
   }' | \
sed 's/COMMON \/BLOCK1\/ /BLOCK1 = /g' | \
sed 's/= /= '\''/g' | \
sed '$a\
     +   '\'' ' >> ntu.cmn
#
cp ntu.cmn $mceep_cmn
cd $mceep_util
make
cd $current_dir

